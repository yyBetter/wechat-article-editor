# ✅ 真实微信公众号发布功能已完成

## 🎉 功能概述

已实现完整的微信公众号发布功能，不再是模拟发布，而是真实调用微信公众平台API！

## 🚀 新增功能

### 1. 封面图片上传
- ✅ 支持上传封面图片（JPG/PNG）
- ✅ 建议尺寸：900x500 像素（16:9）
- ✅ 文件大小限制：2MB
- ✅ 实时预览封面效果
- ✅ 可随时更换或移除封面

### 2. 完整发布流程
```
① 内容验证 → ② 上传封面 → ③ 创建草稿 → ④ 发布文章
```

每个步骤都有：
- 实时进度显示
- 成功/失败状态
- 详细错误信息

### 3. 发布配置选项
- **基本信息**：标题、作者、摘要
- **封面设置**：上传、预览、显示/隐藏
- **发布选项**：
  - 立即推送给所有粉丝
  - 允许留言
  - 声明原创

### 4. 两种发布模式
- **草稿模式**：添加到草稿箱，不推送（可后续手动发布）
- **发布模式**：立即发布并推送给粉丝

## 📋 配置步骤（重要！）

### Step 1: 获取微信公众号凭证

1. 登录 [微信公众平台](https://mp.weixin.qq.com)
2. 进入「设置与开发」->「基本配置」
3. 复制「开发者ID (AppID)」
4. 重置并复制「开发者密码 (AppSecret)」

### Step 2: 配置后端环境变量

在 `server/.env` 文件中添加：

```env
# 微信公众号配置
WECHAT_APP_ID=你的AppID
WECHAT_APP_SECRET=你的AppSecret
```

### Step 3: 配置IP白名单

1. 在微信公众平台「基本配置」找到「IP白名单」
2. 添加你的服务器公网IP
3. **本地开发**: 添加你的出口IP（可访问 https://ip.cn 查看）

### Step 4: 启动服务

```bash
# 启动后端
cd server
npm install
npm run dev

# 启动前端
npm run dev
```

## 🎯 使用方法

### 发布文章流程：

1. **编辑内容**
   - 在编辑器中完成文章创作
   - 预览区查看效果

2. **点击发布按钮**
   - 顶部工具栏：📤 发布到微信公众号

3. **配置发布信息**
   - 填写标题（必填）
   - 填写作者
   - 填写摘要（选填，120字内）
   - **上传封面图片**（点击📷图标）

4. **选择发布选项**
   - ☑️ 立即推送给所有粉丝（慎重选择！）
   - ☑️ 允许留言
   - ☐ 声明原创

5. **开始发布**
   - 点击「📤 开始发布」按钮
   - 等待发布流程完成
   - 查看发布结果

## 📊 API接口说明

### 后端接口：

```
POST /api/wechat/upload-cover       # 上传封面图片
POST /api/wechat/publish-article    # 一键发布文章
GET  /api/wechat/test               # 测试连接
```

### 前端调用：

```typescript
import { publishToWeChat } from '@/utils/wechat-api'

const result = await publishToWeChat({
  title: '文章标题',
  author: '作者',
  content: '文章内容（HTML格式）',
  digest: '摘要',
  coverImageBuffer: 'base64图片数据',
  showCoverPic: 1,
  needOpenComment: 1,
  pushToFollowers: false
})
```

## ⚠️ 注意事项

### 1. 权限要求
- 需要**已认证的微信公众号**
- 需要开通「发布能力」权限
- 个人订阅号权限有限，建议使用企业服务号

### 2. 频率限制
- Access Token: 每日2000次
- 素材上传: 每分钟10次
- 发布接口: 每分钟2次

> 系统已自动缓存Token，避免频繁请求

### 3. 图片要求
- **格式**: JPG、PNG
- **大小**: 不超过2MB
- **尺寸**: 建议 900x500（16:9比例）
- 封面图片会永久保存到微信素材库

### 4. 内容规范
- 文章内容需符合微信公众平台规范
- 避免违规关键词
- 不支持外部链接（会被过滤）

## 🔍 故障排查

### 问题1: "获取Access Token失败"

**原因：**
- AppID 或 AppSecret 配置错误
- 服务器IP未加入白名单

**解决：**
```bash
# 检查配置
cat server/.env | grep WECHAT

# 测试连接
curl -H "Authorization: Bearer YOUR_TOKEN" \
  http://localhost:3001/api/wechat/test
```

### 问题2: "上传图片失败"

**原因：**
- 图片大小超过2MB
- 图片格式不支持

**解决：**
- 压缩图片后重试
- 确保是JPG或PNG格式

### 问题3: "发布后后台看不到"

**原因：**
- 未选择"推送给粉丝"，文章在草稿箱

**解决：**
- 登录微信公众平台
- 查看「素材管理」->「图文消息」->「草稿箱」

### 问题4: "权限不足 (errcode 48001)"

**原因：**
- 公众号类型不支持此接口

**解决：**
- 确认公众号已认证
- 查看「接口权限」列表
- 个人订阅号需升级为企业号

## 📁 相关文件

### 后端：
- `server/src/routes/wechat.ts` - 微信API路由
- `server/src/index.ts` - 路由注册

### 前端：
- `src/utils/wechat-api.ts` - 微信API调用工具
- `src/components/PublishModal.tsx` - 发布模态框（含封面上传）

### 文档：
- `docs/微信公众号发布配置指南.md` - 详细配置说明

## 🎨 界面预览

发布模态框新增了：
- 📷 封面图片上传区域（虚线框）
- 🖼️ 封面预览（带更换/移除按钮）
- 📊 发布进度条（4个步骤）
- ✅ 成功/失败状态提示

## 💡 使用建议

1. **首次使用**：先不勾选"推送给粉丝"，测试发布到草稿箱
2. **封面优化**：使用高质量图片，吸引读者点击
3. **摘要精炼**：120字内概括文章亮点
4. **预览检查**：发布前在预览区仔细检查格式
5. **错峰发布**：避开高峰期，减少失败率

## 🔐 安全提示

1. ⚠️ **不要泄露** AppSecret
2. ⚠️ **不要提交** `.env` 文件到Git
3. ⚠️ **定期更换** AppSecret
4. ⚠️ **限制IP白名单** 只添加必要的IP

## 📞 技术支持

遇到问题？
1. 查看后端日志：`server/logs/`
2. 查看浏览器控制台错误
3. 参考微信官方文档：https://developers.weixin.qq.com/doc/offiaccount/

---

## ✨ 下一步计划

- [ ] 发布历史记录（数据库存储）
- [ ] 多图文发布（一次发布多篇文章）
- [ ] 定时发布功能
- [ ] 发布数据统计（阅读量、点赞数）
- [ ] 草稿箱管理（查看、编辑、删除草稿）

---

**🎉 恭喜！你现在可以直接从编辑器发布文章到微信公众号了！**
