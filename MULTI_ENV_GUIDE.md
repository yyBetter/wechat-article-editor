# ğŸŒ å¤šç¯å¢ƒéƒ¨ç½²å®Œå…¨æŒ‡å—

## ä¸€åˆ†é’Ÿå¿«é€Ÿå¼€å§‹

```bash
# 1. åˆå§‹åŒ–ç¯å¢ƒé…ç½®ï¼ˆé¦–æ¬¡è¿è¡Œï¼‰
./setup-env.sh

# 2. éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ
./deploy-multi-env.sh staging

# 3. æµ‹è¯•é€šè¿‡åï¼Œéƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
./deploy-multi-env.sh production
```

å°±è¿™ä¹ˆç®€å•ï¼âœ¨

---

## ğŸ“– è¯¦ç»†è¯´æ˜

### ç¯å¢ƒæ¶æ„

æœ¬é¡¹ç›®æ”¯æŒå®Œæ•´çš„**å¼€å‘â†’æµ‹è¯•â†’ç”Ÿäº§**ä¸‰ç¯å¢ƒéš”ç¦»ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         æœ¬åœ°å¼€å‘                              â”‚
â”‚  Environment: development                                    â”‚
â”‚  Database: dev.db                                           â”‚
â”‚  API: http://localhost:3002                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“ æ¨é€ä»£ç 
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         æµ‹è¯•ç¯å¢ƒ                              â”‚
â”‚  Environment: staging                                        â”‚
â”‚  Server: /opt/wechat-editor-staging                         â”‚
â”‚  Database: staging.db                                       â”‚
â”‚  PM2: wechat-editor-staging                                 â”‚
â”‚  Frontend: /var/www/staging                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“ æµ‹è¯•é€šè¿‡
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ç”Ÿäº§ç¯å¢ƒ                              â”‚
â”‚  Environment: production                                     â”‚
â”‚  Server: /opt/wechat-editor                                 â”‚
â”‚  Database: production.db                                    â”‚
â”‚  PM2: wechat-editor                                         â”‚
â”‚  Frontend: /var/www/html                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒç‰¹æ€§

âœ… **å®Œå…¨æ•°æ®éš”ç¦»** - æµ‹è¯•å’Œç”Ÿäº§ä½¿ç”¨ç‹¬ç«‹æ•°æ®åº“  
âœ… **ç‹¬ç«‹è¿›ç¨‹ç®¡ç†** - PM2åˆ†åˆ«ç®¡ç†ä¸¤ä¸ªç¯å¢ƒ  
âœ… **ä¸€é”®éƒ¨ç½²** - è‡ªåŠ¨åŒ–æ„å»ºã€ä¸Šä¼ ã€é‡å¯  
âœ… **ç¯å¢ƒå˜é‡ç®¡ç†** - æ¯ä¸ªç¯å¢ƒç‹¬ç«‹é…ç½®  
âœ… **é›¶åœæœºéƒ¨ç½²** - PM2ä¼˜é›…é‡å¯  

---

## ğŸš€ æ ‡å‡†å·¥ä½œæµç¨‹

### é˜¶æ®µ1: æœ¬åœ°å¼€å‘

```bash
# é¦–æ¬¡è¿è¡Œï¼šåˆå§‹åŒ–ç¯å¢ƒé…ç½®
./setup-env.sh

# å¯åŠ¨å¼€å‘æœåŠ¡å™¨
npm run dev
```

è®¿é—® `http://localhost:3001` è¿›è¡Œå¼€å‘

### é˜¶æ®µ2: éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ

åŠŸèƒ½å¼€å‘å®Œæˆåï¼Œéƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒè¿›è¡ŒéªŒè¯ï¼š

```bash
./deploy-multi-env.sh staging
```

è„šæœ¬ä¼šè‡ªåŠ¨å®Œæˆï¼š
1. æ„å»ºå‰ç«¯ï¼ˆä½¿ç”¨stagingé…ç½®ï¼‰
2. æ„å»ºåç«¯ï¼ˆä½¿ç”¨stagingé…ç½®ï¼‰
3. ä¸Šä¼ åˆ°æµ‹è¯•ç›®å½•
4. åŒæ­¥stagingæ•°æ®åº“
5. é‡å¯stagingæœåŠ¡
6. éªŒè¯éƒ¨ç½²ç»“æœ

è®¿é—® `http://47.55.117.20` è¿›è¡Œæµ‹è¯•

### é˜¶æ®µ3: éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ

æµ‹è¯•é€šè¿‡åï¼Œéƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒï¼š

```bash
./deploy-multi-env.sh production
```

âš ï¸ **æ³¨æ„**ï¼šéƒ¨ç½²ç”Ÿäº§ç¯å¢ƒæ—¶ä¼šè¦æ±‚äºŒæ¬¡ç¡®è®¤ï¼

---

## ğŸ“ ç¯å¢ƒé…ç½®è¯¦è§£

### é…ç½®æ–‡ä»¶è¯´æ˜

| æ–‡ä»¶ | ç”¨é€” | Gitè¿½è¸ª |
|------|------|---------|
| `.env.development` | æœ¬åœ°å¼€å‘é…ç½® | âŒ ä¸è¿½è¸ª |
| `.env.staging` | æµ‹è¯•ç¯å¢ƒé…ç½® | âŒ ä¸è¿½è¸ª |
| `.env.production` | ç”Ÿäº§ç¯å¢ƒé…ç½® | âŒ ä¸è¿½è¸ª |
| `.env` | å½“å‰ä½¿ç”¨çš„é…ç½® | âŒ ä¸è¿½è¸ª |

### å…³é”®é…ç½®é¡¹

#### 1. VITE_API_BASE_URL
- **å¼€å‘ç¯å¢ƒ**: `http://localhost:3002` ï¼ˆç›´è¿åç«¯ï¼‰
- **æµ‹è¯•/ç”Ÿäº§**: ç•™ç©º ï¼ˆé€šè¿‡Nginxä»£ç†ï¼‰

#### 2. DATABASE_URL
- **å¼€å‘**: `file:./dev.db`
- **æµ‹è¯•**: `file:./staging.db`
- **ç”Ÿäº§**: `file:./production.db`

#### 3. JWT_SECRET
- æ¯ä¸ªç¯å¢ƒä½¿ç”¨**ä¸åŒçš„å¯†é’¥**
- ç”Ÿäº§ç¯å¢ƒå¯†é’¥æœ€å¼º
- `setup-env.sh` ä¼šè‡ªåŠ¨ç”Ÿæˆ

#### 4. CORS_ORIGIN
- **å¼€å‘**: `http://localhost:3001`
- **æµ‹è¯•**: `http://staging.yourdomain.com,http://localhost:3001`
- **ç”Ÿäº§**: `http://healthism.top,https://healthism.top`

---

## ğŸ—‚ï¸ æœåŠ¡å™¨ç›®å½•ç»“æ„

```
/opt/
â”œâ”€â”€ wechat-editor/              # ç”Ÿäº§ç¯å¢ƒ
â”‚   â”œâ”€â”€ dist/                   # åç«¯ä»£ç 
â”‚   â”œâ”€â”€ prisma/
â”‚   â”‚   â””â”€â”€ production.db       # ç”Ÿäº§æ•°æ®åº“ â­
â”‚   â”œâ”€â”€ uploads/                # ä¸Šä¼ æ–‡ä»¶
â”‚   â”œâ”€â”€ package.json
â”‚   â””â”€â”€ .env                    # ç”Ÿäº§é…ç½®
â”‚
â””â”€â”€ wechat-editor-staging/      # æµ‹è¯•ç¯å¢ƒ
    â”œâ”€â”€ dist/
    â”œâ”€â”€ prisma/
    â”‚   â””â”€â”€ staging.db          # æµ‹è¯•æ•°æ®åº“ â­
    â”œâ”€â”€ uploads/
    â”œâ”€â”€ package.json
    â””â”€â”€ .env                    # æµ‹è¯•é…ç½®

/var/www/
â”œâ”€â”€ html/                       # ç”Ÿäº§å‰ç«¯ â­
â”‚   â”œâ”€â”€ index.html
â”‚   â””â”€â”€ assets/
â”‚
â””â”€â”€ staging/                    # æµ‹è¯•å‰ç«¯ â­
    â”œâ”€â”€ index.html
    â””â”€â”€ assets/
```

---

## ğŸ”§ å¸¸ç”¨ç®¡ç†å‘½ä»¤

### æŸ¥çœ‹æ‰€æœ‰ç¯å¢ƒçŠ¶æ€

```bash
ssh root@47.55.117.20 'pm2 status'
```

### æµ‹è¯•ç¯å¢ƒç®¡ç†

```bash
# æŸ¥çœ‹æµ‹è¯•ç¯å¢ƒæ—¥å¿—
ssh root@47.55.117.20 'pm2 logs wechat-editor-staging --lines 50'

# é‡å¯æµ‹è¯•ç¯å¢ƒ
ssh root@47.55.117.20 'pm2 restart wechat-editor-staging'

# åœæ­¢æµ‹è¯•ç¯å¢ƒ
ssh root@47.55.117.20 'pm2 stop wechat-editor-staging'

# æŸ¥çœ‹æµ‹è¯•æ•°æ®åº“å¤§å°
ssh root@47.55.117.20 'ls -lh /opt/wechat-editor-staging/prisma/*.db'
```

### ç”Ÿäº§ç¯å¢ƒç®¡ç†

```bash
# æŸ¥çœ‹ç”Ÿäº§ç¯å¢ƒæ—¥å¿—
ssh root@47.55.117.20 'pm2 logs wechat-editor --lines 50'

# é‡å¯ç”Ÿäº§ç¯å¢ƒ
ssh root@47.55.117.20 'pm2 restart wechat-editor'

# æŸ¥çœ‹ç”Ÿäº§æ•°æ®åº“å¤§å°
ssh root@47.55.117.20 'ls -lh /opt/wechat-editor/prisma/*.db'
```

---

## ğŸ’¾ æ•°æ®ç®¡ç†

### å¤‡ä»½ç”Ÿäº§æ•°æ®åº“

```bash
# SSHåˆ°æœåŠ¡å™¨
ssh root@47.55.117.20

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p /root/backups

# å¤‡ä»½æ•°æ®åº“
cd /opt/wechat-editor/prisma
tar -czf /root/backups/prod-db-$(date +%Y%m%d-%H%M%S).tar.gz production.db

# æŸ¥çœ‹å¤‡ä»½
ls -lh /root/backups/
```

### ä¸‹è½½å¤‡ä»½åˆ°æœ¬åœ°

```bash
# åœ¨æœ¬åœ°æ‰§è¡Œ
mkdir -p backups
scp root@47.55.117.20:/root/backups/prod-db-*.tar.gz backups/
```

### ä»æµ‹è¯•ç¯å¢ƒå¤åˆ¶æ•°æ®åˆ°ç”Ÿäº§

```bash
ssh root@47.55.117.20 << 'EOF'
# âš ï¸ è°¨æ…æ“ä½œï¼å…ˆå¤‡ä»½ç”Ÿäº§æ•°æ®
cd /opt/wechat-editor/prisma
cp production.db production.db.backup-$(date +%Y%m%d)

# å¤åˆ¶æµ‹è¯•æ•°æ®åˆ°ç”Ÿäº§
cp /opt/wechat-editor-staging/prisma/staging.db production.db

# é‡å¯ç”Ÿäº§æœåŠ¡
pm2 restart wechat-editor
EOF
```

---

## ğŸ¯ æœ€ä½³å®è·µ

### 1. å¼€å‘æµç¨‹

```bash
# æœ¬åœ°å¼€å‘
git checkout -b feature/new-feature
npm run dev
# å¼€å‘åŠŸèƒ½...
git commit -m "feat: æ–°åŠŸèƒ½"
git push

# éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ
./deploy-multi-env.sh staging
# åœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯...

# æµ‹è¯•é€šè¿‡åéƒ¨ç½²åˆ°ç”Ÿäº§
git checkout main
git merge feature/new-feature
./deploy-multi-env.sh production
```

### 2. é…ç½®ç®¡ç†

- âœ… ä½¿ç”¨ `setup-env.sh` åˆå§‹åŒ–é…ç½®
- âœ… ä¸è¦æäº¤ `.env*` æ–‡ä»¶åˆ°Git
- âœ… ç”Ÿäº§ç¯å¢ƒä½¿ç”¨å¼ºJWTå¯†é’¥
- âœ… å®šæœŸæ›´æ¢å¯†é’¥

### 3. æ•°æ®å®‰å…¨

- âœ… æ¯å‘¨å¤‡ä»½ç”Ÿäº§æ•°æ®åº“
- âœ… é‡å¤§æ›´æ–°å‰æ‰‹åŠ¨å¤‡ä»½
- âœ… ä¿ç•™æœ€è¿‘7å¤©çš„å¤‡ä»½
- âœ… æµ‹è¯•ç¯å¢ƒä½¿ç”¨æµ‹è¯•æ•°æ®

### 4. ç›‘æ§å’Œæ—¥å¿—

```bash
# å®šæ—¶æ£€æŸ¥æœåŠ¡çŠ¶æ€
watch -n 5 'ssh root@47.55.117.20 pm2 status'

# å®æ—¶æŸ¥çœ‹ç”Ÿäº§æ—¥å¿—
ssh root@47.55.117.20 'pm2 logs wechat-editor'

# æŸ¥çœ‹ç³»ç»Ÿèµ„æº
ssh root@47.55.117.20 'pm2 monit'
```

---

## ğŸ› æ•…éšœæ’æŸ¥

### é—®é¢˜1: éƒ¨ç½²å401é”™è¯¯

**åŸå› **: Nginxæ²¡æœ‰æ­£ç¡®ä»£ç†API

**è§£å†³**:
```bash
ssh root@47.55.117.20
sudo nginx -t
sudo systemctl reload nginx
```

### é—®é¢˜2: æ•°æ®åº“é”™è¯¯

**åŸå› **: æ•°æ®åº“schemaä¸åŒ¹é…

**è§£å†³**:
```bash
ssh root@47.55.117.20
cd /opt/wechat-editor  # æˆ– /opt/wechat-editor-staging
npx prisma db push --accept-data-loss
pm2 restart wechat-editor  # æˆ– wechat-editor-staging
```

### é—®é¢˜3: æœåŠ¡æ— æ³•å¯åŠ¨

**åŸå› **: ç«¯å£è¢«å ç”¨æˆ–é…ç½®é”™è¯¯

**è§£å†³**:
```bash
ssh root@47.55.117.20

# æŸ¥çœ‹ç«¯å£å ç”¨
netstat -tlnp | grep 3002

# æ£€æŸ¥PM2æ—¥å¿—
pm2 logs wechat-editor --lines 100

# æ£€æŸ¥ç¯å¢ƒé…ç½®
cat /opt/wechat-editor/.env
```

### é—®é¢˜4: å‰ç«¯æ˜¾ç¤ºç©ºç™½

**åŸå› **: æµè§ˆå™¨ç¼“å­˜

**è§£å†³**: æŒ‰ `Ctrl+Shift+R` å¼ºåˆ¶åˆ·æ–°

---

## ğŸ“ å¿«é€Ÿå‚è€ƒ

### ä¸€é”®éƒ¨ç½²
```bash
./deploy-multi-env.sh staging     # æµ‹è¯•ç¯å¢ƒ
./deploy-multi-env.sh production  # ç”Ÿäº§ç¯å¢ƒ
```

### å¸¸ç”¨å‘½ä»¤
```bash
# æŸ¥çœ‹çŠ¶æ€
ssh root@47.55.117.20 'pm2 status'

# æŸ¥çœ‹æ—¥å¿—
ssh root@47.55.117.20 'pm2 logs <app-name>'

# é‡å¯æœåŠ¡
ssh root@47.55.117.20 'pm2 restart <app-name>'

# å¤‡ä»½æ•°æ®åº“
ssh root@47.55.117.20 'cd /opt/wechat-editor/prisma && tar -czf backup-$(date +%Y%m%d).tar.gz production.db'
```

### åº”ç”¨åç§°
- æµ‹è¯•ç¯å¢ƒ: `wechat-editor-staging`
- ç”Ÿäº§ç¯å¢ƒ: `wechat-editor`

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- `ENV_SETUP.md` - è¯¦ç»†çš„ç¯å¢ƒé…ç½®è¯´æ˜
- `DEPLOY_QUICK.md` - å¿«é€Ÿéƒ¨ç½²æŒ‡å—ï¼ˆå•ç¯å¢ƒï¼‰
- `setup-env.sh` - ç¯å¢ƒé…ç½®åˆå§‹åŒ–è„šæœ¬
- `deploy-multi-env.sh` - å¤šç¯å¢ƒéƒ¨ç½²è„šæœ¬

---

## âœ¨ æ€»ç»“

é€šè¿‡è¿™å¥—å¤šç¯å¢ƒæ–¹æ¡ˆï¼Œä½ å¯ä»¥ï¼š

1. âœ… **æœ¬åœ°å¼€å‘** - å¿«é€Ÿè¿­ä»£ï¼Œå®æ—¶é¢„è§ˆ
2. âœ… **æµ‹è¯•éªŒè¯** - åœ¨stagingç¯å¢ƒå……åˆ†æµ‹è¯•
3. âœ… **å®‰å…¨å‘å¸ƒ** - ç”Ÿäº§ç¯å¢ƒæ•°æ®éš”ç¦»ï¼Œé£é™©å¯æ§
4. âœ… **å¿«é€Ÿå›æ»š** - ä¿ç•™å¤‡ä»½ï¼Œéšæ—¶æ¢å¤
5. âœ… **å›¢é˜Ÿåä½œ** - ç»Ÿä¸€çš„éƒ¨ç½²æµç¨‹

**ç°åœ¨éƒ¨ç½²åªéœ€ä¸€æ¡å‘½ä»¤ï¼Œæ•°æ®å®Œå…¨éš”ç¦»ï¼Œå†ä¹Ÿä¸ç”¨æ‹…å¿ƒæµ‹è¯•å½±å“ç”Ÿäº§äº†ï¼** ğŸ‰

