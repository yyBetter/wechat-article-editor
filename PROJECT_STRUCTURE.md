# 微信公众号排版工具 - 项目功能结构文档

> 最后更新：2025-08-31
> 版本：v1.0.0

## 1. 核心架构概览 (Core Architecture)

**技术栈**: React 18 + TypeScript + Vite + Marked + DOMPurify

**核心设计模式**: Template-Engine-Preview 三层架构
- **模板层**: 定义样式规则和固定元素
- **引擎层**: 处理 Markdown 转换和模板应用  
- **预览层**: 实时渲染微信风格的 HTML

## 2. 状态管理架构 (State Management)

**Context + useReducer 模式** (`src/utils/app-context.tsx:7-79`)

核心状态结构:
- **editor**: 编辑器内容、光标位置、保存状态
- **preview**: 预览 HTML、CSS、设备模式、缩放比例  
- **templates**: 可用模板、当前模板、变量配置
- **assets**: 图片资源、图片占位符映射、品牌资产、上传队列
- **export**: 导出状态、历史记录
- **ui**: 侧边栏状态、活动面板、主题设置

## 3. 模板系统设计 (Template System)

**模板引擎** (`src/utils/template-engine.ts`)
- **智能模板推荐**: 基于内容分析(字数、图片数、代码块)自动推荐合适模板
- **多重缓存机制**: Markdown解析、CSS生成、内容分析、模板字符串缓存
- **品牌色彩系统**: 动态替换模板预设颜色为用户品牌色

**现有模板**:
- `simple-doc`: 简约文档模板 - 文字内容为主，技术文档风格
- `image-text`: 图文模板 - 图片展示优化，产品介绍风格

## 4. 编辑器功能模块 (Editor Features)

**高性能编辑器** (`src/components/Editor.tsx`)
- **图片处理**: 智能压缩(最大2MB)、Base64转换、拖拽上传、剪贴板粘贴
- **Markdown工具栏**: 粗体、斜体、标题、链接、图片、列表、引用、代码
- **性能优化**: 防抖输入(100ms)、React.memo、缓存计算

**图片管理系统**:
- 自动压缩(1200px宽度，0.8质量)
- 简洁占位符机制(`![文件名](🖼️ img_xx)`)避免编辑器显示长Base64字符串
- 全局状态管理图片映射，编辑器和预览组件共享图片数据
- 预览时自动还原真实图片数据，确保复制到微信编辑器时图片正常显示

## 5. 预览系统 (Preview System)

**实时预览** (`src/components/Preview.tsx`)
- **双版本渲染**: 预览显示版本 + 复制用内联样式版本
- **设备模式**: 移动端/桌面端切换预览
- **一键复制**: Ctrl+A全选 + Ctrl+C复制到微信编辑器
- **品牌色彩应用**: 动态替换CSS中的颜色变量

## 6. 发布流程 (Publishing Workflow)

**发布管理** (`src/components/PublishFlow.tsx`)
- **预览功能**: 生成预览链接和二维码
- **发布流程**: 内容验证 → 素材上传 → 创建图文 → 发布文章
- **发布历史**: 记录和管理已发布内容
- **发布配置**: 推送设置、留言功能、原创标记

## 7. 全局设置 (Global Settings)

**设置管理** (`src/components/Settings.tsx`)
- **文章信息**: 标题、作者、发布日期
- **品牌配色**: 3色主题色彩配置
- **微信配置**: 公众号授权和API配置
- **高级选项**: 自动保存、实时预览、微信优化

## 8. UI组件架构 (UI Architecture)

**布局结构** (`src/App.tsx:33-136`)
```
顶部导航栏 (Header)
├── 左侧: 侧边栏切换 + 应用标题
└── 右侧: 当前模板信息 + 导出按钮

主内容区域 (Main)
├── 左侧边栏 (Sidebar) - 可折叠
│   ├── 模板选择 (Templates)
│   ├── 发布管理 (Publish)  
│   └── 全局设置 (Settings)
├── 编辑器区域 (Editor)
└── 预览区域 (Preview)

底部状态栏 (Footer)
├── 保存状态提示
└── 版本信息
```

## 9. 核心特性总结 (Key Features)

1. **智能模板系统**: 基于内容特征自动推荐模板
2. **高性能图片处理**: 压缩、缓存、占位符优化
3. **品牌一体化**: 全局色彩配置自动应用到所有模板
4. **微信优化**: 符合微信编辑器的样式规范和复制机制
5. **实时预览**: 防抖优化的即时渲染
6. **发布流程**: 完整的微信公众号发布工作流

---

## 修改历史 (Change Log)

### v1.0.3 (2025-08-31)
- 修复预览区H2标题蓝色样式渲染问题
- 预览区现在正确显示带CSS样式的HTML版本
- 添加品牌色彩应用的调试信息

### v1.0.2 (2025-08-31)
- 修复预览区复制功能，确保图片正常粘贴到微信编辑器
- 添加全局状态管理图片映射(`assets.imageMap`)
- 预览组件现在能正确还原图片占位符为真实Base64数据
- 新增`UPDATE_IMAGE_MAP`状态动作用于同步图片数据

### v1.0.1 (2025-08-31)
- 优化编辑器图片占位机制
- 图片上传后显示简洁占位符(`![文件名](🖼️ img_xx)`)，避免长Base64字符串影响编辑体验
- 预览时自动还原真实图片数据

### v1.0.0 (2025-08-31)
- 初始项目功能结构文档
- 完整的9个功能模块分析
- 核心架构和技术栈说明