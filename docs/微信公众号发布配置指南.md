# 微信公众号发布配置指南

## 📋 前置条件

1. 已认证的微信公众号（服务号或订阅号）
2. 已开通"发布能力"权限
3. 服务器IP已加入白名单

## 🔧 配置步骤

### 1. 获取微信公众号凭证

1. 登录[微信公众平台](https://mp.weixin.qq.com)
2. 进入「设置与开发」->「基本配置」
3. 找到「开发者ID(AppID)」和「开发者密码(AppSecret)」
4. 如果AppSecret未设置或忘记，点击「重置」按钮

### 2. 配置服务器环境变量

在 `server/.env` 文件中添加以下配置：

```env
# 微信公众号配置
WECHAT_APP_ID=wx1234567890abcdef  # 替换为你的AppID
WECHAT_APP_SECRET=abcdef1234567890abcdef1234567890  # 替换为你的AppSecret
```

### 3. 配置服务器IP白名单

1. 在微信公众平台「基本配置」页面找到「IP白名单」
2. 点击「修改」
3. 添加你的服务器公网IP地址
4. 保存

> ⚠️ **重要**: 未添加到白名单的IP无法调用微信API

### 4. 启动后端服务

```bash
cd server
npm install
npm run dev
```

服务器将在 `http://localhost:3001` 启动

### 5. 前端配置（可选）

如果需要自定义API地址，在前端项目根目录创建 `.env` 文件：

```env
VITE_API_URL=http://localhost:3001
```

## 🚀 功能说明

### 支持的发布功能

- ✅ 上传封面图片到微信素材库
- ✅ 创建草稿箱图文消息
- ✅ 发布文章到公众号
- ✅ 选择是否推送给粉丝
- ✅ 配置评论和原创声明

### 封面图片要求

- **格式**: JPG、PNG
- **大小**: 不超过2MB
- **尺寸**: 建议 900x500 像素（16:9 比例）
- **说明**: 封面图片会显示在分享卡片和文章顶部

### API限流说明

微信公众平台API有调用频率限制：

- **Access Token**: 每日最多获取2000次
- **素材上传**: 每分钟最多10次
- **发布接口**: 每分钟最多2次

> 💡 本系统已自动缓存Access Token，避免频繁请求

## 🔍 测试连接

1. 启动后端服务
2. 登录编辑器
3. 点击"发布到微信"按钮
4. 查看授权状态提示

或者直接访问测试接口：

```bash
curl -H "Authorization: Bearer YOUR_TOKEN" \
  http://localhost:3001/api/wechat/test
```

## ❌ 常见问题

### 1. 提示"获取Access Token失败"

**可能原因：**
- AppID 或 AppSecret 配置错误
- 服务器IP未加入白名单
- 微信公众号类型不支持（个人订阅号不支持部分接口）

**解决方法：**
- 检查 `.env` 配置是否正确
- 确认IP白名单已添加
- 查看后端日志获取详细错误信息

### 2. 上传图片失败

**可能原因：**
- 图片大小超过2MB
- 图片格式不支持
- 网络问题

**解决方法：**
- 压缩图片后重试
- 确保图片为JPG或PNG格式
- 检查网络连接

### 3. 发布后在后台看不到

**可能原因：**
- 未选择"推送给粉丝"，文章在草稿箱
- 发布失败但未提示

**解决方法：**
- 登录微信公众平台后台
- 检查「素材管理」->「图文消息」
- 查看草稿箱是否有对应文章

### 4. 权限不足

**错误码 48001: api unauthorized**

这说明你的公众号没有相应的接口权限。

**解决方法：**
- 确认公众号类型（个人订阅号权限有限）
- 在「设置与开发」->「接口权限」中查看权限列表
- 如需更多权限，需进行公众号认证

## 📚 参考资料

- [微信公众平台技术文档](https://developers.weixin.qq.com/doc/offiaccount/Getting_Started/Overview.html)
- [草稿箱管理接口](https://developers.weixin.qq.com/doc/offiaccount/Draft_Box/Add_draft.html)
- [发布接口](https://developers.weixin.qq.com/doc/offiaccount/Publish/Publish.html)
- [素材管理接口](https://developers.weixin.qq.com/doc/offiaccount/Asset_Management/New_temporary_materials.html)

## 💡 最佳实践

1. **定期备份**: 发布前建议在本地保存文章副本
2. **预览检查**: 使用微信后台的预览功能确认排版
3. **错峰发布**: 避免在高峰期发布，减少失败率
4. **封面优化**: 使用高质量封面图片吸引读者
5. **内容审核**: 确保内容符合微信公众平台规范

## 🛡️ 安全建议

1. **保护密钥**: 不要将 AppSecret 提交到版本控制系统
2. **限制IP**: 只添加必要的IP到白名单
3. **定期更换**: 定期更换 AppSecret 提升安全性
4. **权限最小化**: 只开启必要的接口权限

---

如有问题，请查看后端日志 (`server/logs/`) 获取详细错误信息。
