# 环境架构设计方案

## 一、环境分层

### 1.1 三大环境定义

| 环境 | 用途 | 特点 | 访问控制 |
|------|------|------|----------|
| **Development** | 本地开发 | 快速迭代、详细日志、热重载 | 开发人员 |
| **Staging** | 预发布测试 | 接近生产、完整功能、性能测试 | 测试人员 + 核心用户 |
| **Production** | 正式生产 | 稳定可靠、高性能、监控告警 | 所有用户 |

---

## 二、核心差异对比

### 2.1 数据库策略

```typescript
// Development
provider: 'sqlite'
url: 'file:./prisma/dev.db'
优点: 零配置、快速启动
缺点: 功能受限

// Staging
provider: 'postgresql'
url: process.env.STAGING_DATABASE_URL
优点: 与生产一致、完整功能测试
缺点: 需要配置

// Production
provider: 'postgresql'
url: process.env.DATABASE_URL
ssl: true
connectionLimit: 50
poolTimeout: 30
优点: 高性能、高可用、数据安全
```

### 2.2 API配置

```typescript
const API_CONFIG = {
  development: {
    baseUrl: 'http://localhost:3002',
    timeout: 30000,  // 30秒（方便调试）
    retries: 0,      // 不重试（快速失败）
  },
  staging: {
    baseUrl: 'https://staging-api.yourdomain.com',
    timeout: 10000,  // 10秒
    retries: 2,      // 重试2次
  },
  production: {
    baseUrl: 'https://api.yourdomain.com',
    timeout: 5000,   // 5秒
    retries: 3,      // 重试3次
    rateLimit: true, // 启用限流
  },
}
```

### 2.3 微信公众号配置

```typescript
const WECHAT_CONFIG = {
  development: {
    // 使用测试号 - 每个开发者独立申请
    sandbox: true,
    validateSignature: false, // 简化开发
  },
  staging: {
    // 使用测试公众号 - 团队共享
    sandbox: false,
    validateSignature: true,
  },
  production: {
    // 用户自己的真实公众号
    sandbox: false,
    validateSignature: true,
    strictMode: true, // 严格验证
  },
}
```

### 2.4 AI服务配置

```typescript
const AI_CONFIG = {
  development: {
    apiKey: process.env.DEV_DEEPSEEK_KEY, // 开发专用key
    usageLimit: null,  // 无限制
    logPrompts: true,  // 记录所有prompt（调试用）
  },
  staging: {
    apiKey: process.env.STAGING_DEEPSEEK_KEY,
    usageLimit: 1000,  // 每天1000次
    logPrompts: true,
  },
  production: {
    apiKey: process.env.PROD_DEEPSEEK_KEY,
    usageLimit: 100000, // 每天10万次
    logPrompts: false,  // 不记录（隐私）
    cacheEnabled: true, // 启用缓存
  },
}
```

### 2.5 日志级别

```typescript
const LOG_CONFIG = {
  development: {
    level: 'debug',
    prettyPrint: true,
    destination: 'console',
  },
  staging: {
    level: 'info',
    prettyPrint: false,
    destination: 'file', // logs/staging.log
  },
  production: {
    level: 'warn',
    prettyPrint: false,
    destination: 'sentry', // 错误追踪服务
  },
}
```

---

## 三、配置管理方案

### 3.1 文件结构

```
project/
├── .env.development          # 开发环境（可提交，无敏感信息）
├── .env.staging              # 测试环境（可提交，无敏感信息）
├── .env.production           # 生产环境（不提交！）
├── .env.local                # 个人本地覆盖（不提交！）
├── config/
│   ├── index.ts              # 配置入口
│   ├── development.ts        # 开发配置
│   ├── staging.ts            # 测试配置
│   └── production.ts         # 生产配置
└── docs/
    └── .env.example          # 环境变量模板
```

### 3.2 优先级规则

```
环境变量 > .env.local > .env.[mode] > 代码默认值
```

### 3.3 敏感信息管理

**开发环境**：
```bash
# .env.development (可提交)
VITE_API_BASE_URL=http://localhost:3002
VITE_ENABLE_DEBUG=true
# 注意：不包含真实的API密钥
```

**生产环境**：
```bash
# .env.production (不提交！使用密钥管理服务)
DATABASE_URL=postgresql://user:pass@prod-db.com/db
DEEPSEEK_API_KEY=sk-prod-xxxxx
JWT_SECRET=super-secret-key
WECHAT_APP_SECRET=your-secret
```

---

## 四、代码实现

### 4.1 统一配置入口

```typescript
// config/index.ts
import { developmentConfig } from './development'
import { stagingConfig } from './staging'
import { productionConfig } from './production'

export type Environment = 'development' | 'staging' | 'production'

export interface AppConfig {
  env: Environment
  api: {
    baseUrl: string
    timeout: number
    retries: number
  }
  database: {
    provider: string
    url: string
  }
  wechat: {
    sandbox: boolean
    validateSignature: boolean
  }
  ai: {
    provider: 'deepseek'
    apiKey: string
    usageLimit: number | null
  }
  features: {
    analytics: boolean
    errorTracking: boolean
    performanceMonitoring: boolean
  }
  security: {
    rateLimit: boolean
    corsOrigins: string[]
    allowedDomains: string[]
  }
}

const ENV = (import.meta.env.MODE || process.env.NODE_ENV || 'development') as Environment

const configs: Record<Environment, AppConfig> = {
  development: developmentConfig,
  staging: stagingConfig,
  production: productionConfig,
}

export const config = configs[ENV]

// 导出便捷函数
export const isDevelopment = () => ENV === 'development'
export const isStaging = () => ENV === 'staging'
export const isProduction = () => ENV === 'production'
export const getEnv = () => ENV
```

### 4.2 开发环境配置

```typescript
// config/development.ts
export const developmentConfig: AppConfig = {
  env: 'development',
  api: {
    baseUrl: 'http://localhost:3002',
    timeout: 30000,
    retries: 0,
  },
  database: {
    provider: 'sqlite',
    url: 'file:./prisma/dev.db',
  },
  wechat: {
    sandbox: true,
    validateSignature: false,
  },
  ai: {
    provider: 'deepseek',
    apiKey: import.meta.env.VITE_DEEPSEEK_API_KEY || '',
    usageLimit: null, // 开发无限制
  },
  features: {
    analytics: false,
    errorTracking: false,
    performanceMonitoring: false,
  },
  security: {
    rateLimit: false,
    corsOrigins: ['http://localhost:3001'],
    allowedDomains: ['localhost'],
  },
}
```

### 4.3 生产环境配置

```typescript
// config/production.ts
export const productionConfig: AppConfig = {
  env: 'production',
  api: {
    baseUrl: process.env.VITE_API_BASE_URL || 'https://api.yourdomain.com',
    timeout: 5000,
    retries: 3,
  },
  database: {
    provider: 'postgresql',
    url: process.env.DATABASE_URL!,
  },
  wechat: {
    sandbox: false,
    validateSignature: true,
  },
  ai: {
    provider: 'deepseek',
    apiKey: process.env.DEEPSEEK_API_KEY!,
    usageLimit: 100000,
  },
  features: {
    analytics: true,
    errorTracking: true,
    performanceMonitoring: true,
  },
  security: {
    rateLimit: true,
    corsOrigins: ['https://yourdomain.com'],
    allowedDomains: ['yourdomain.com'],
  },
}
```

### 4.4 使用示例

```typescript
// 在任何文件中使用
import { config, isProduction } from '@/config'

// API请求
const response = await fetch(`${config.api.baseUrl}/api/users`)

// 条件功能
if (config.features.analytics) {
  trackEvent('user_action')
}

// 环境判断
if (isProduction()) {
  // 生产环境特殊逻辑
  enableStrictMode()
} else {
  // 开发环境调试
  console.log('Debug info:', data)
}
```

---

## 五、数据库迁移策略

### 5.1 Prisma多环境配置

```typescript
// prisma/schema.prisma
datasource db {
  provider = env("DATABASE_PROVIDER") // "sqlite" | "postgresql"
  url      = env("DATABASE_URL")
}
```

```bash
# .env.development
DATABASE_PROVIDER=sqlite
DATABASE_URL=file:./prisma/dev.db

# .env.production
DATABASE_PROVIDER=postgresql
DATABASE_URL=postgresql://user:pass@host:5432/db
```

### 5.2 迁移命令

```bash
# 开发环境：使用SQLite
npm run db:migrate:dev

# 生产环境：使用PostgreSQL
npm run db:migrate:prod

# 生成Prisma Client（自动检测环境）
npm run db:generate
```

---

## 六、部署流程

### 6.1 开发环境

```bash
# 1. 克隆代码
git clone your-repo

# 2. 安装依赖
npm install

# 3. 复制环境变量模板
cp .env.example .env.local

# 4. 初始化数据库
npm run db:migrate:dev

# 5. 启动开发服务器
npm run dev
```

### 6.2 测试环境

```bash
# 使用Docker Compose
docker-compose -f docker-compose.staging.yml up -d

# 或者使用K8s
kubectl apply -f k8s/staging/
```

### 6.3 生产环境

```bash
# 蓝绿部署 / 滚动更新
kubectl apply -f k8s/production/
kubectl rollout status deployment/app

# 或者使用CI/CD (GitHub Actions)
git push origin main  # 自动触发部署
```

---

## 七、兼容性保证

### 7.1 API版本控制

```typescript
// 后端路由
app.use('/api/v1', v1Routes)  // 稳定版本
app.use('/api/v2', v2Routes)  // 新版本（渐进式迁移）

// 前端适配
const API_VERSION = config.api.version || 'v1'
const endpoint = `${config.api.baseUrl}/api/${API_VERSION}/users`
```

### 7.2 Feature Flags

```typescript
// config/features.ts
export const FEATURES = {
  NEW_EDITOR: {
    development: true,
    staging: true,
    production: false,  // 灰度发布
  },
  AI_POLISH: {
    development: true,
    staging: true,
    production: true,
  },
}

// 使用
import { FEATURES } from '@/config/features'

if (FEATURES.NEW_EDITOR[config.env]) {
  return <NewEditor />
} else {
  return <LegacyEditor />
}
```

### 7.3 渐进式升级

```typescript
// 用户级别的功能开关
const userCanAccessFeature = (feature: string) => {
  if (config.env === 'development') return true
  
  // 生产环境：根据用户ID/角色灰度放量
  if (user.isAdmin) return true
  if (user.id % 10 === 0) return true  // 10%用户
  
  return false
}
```

---

## 八、监控与告警

### 8.1 错误追踪

```typescript
// Sentry配置
import * as Sentry from '@sentry/react'

if (isProduction()) {
  Sentry.init({
    dsn: config.sentry.dsn,
    environment: config.env,
    tracesSampleRate: 0.1,  // 10%采样
  })
}
```

### 8.2 性能监控

```typescript
// 性能指标上报
if (config.features.performanceMonitoring) {
  const observer = new PerformanceObserver((list) => {
    for (const entry of list.getEntries()) {
      analytics.track('performance', {
        metric: entry.name,
        value: entry.duration,
      })
    }
  })
  observer.observe({ entryTypes: ['measure'] })
}
```

---

## 九、安全最佳实践

### 9.1 密钥管理

**❌ 不要做**：
```typescript
const API_KEY = 'sk-12345abcdef'  // 硬编码
```

**✅ 应该做**：
```typescript
const API_KEY = process.env.DEEPSEEK_API_KEY
if (!API_KEY) {
  throw new Error('DEEPSEEK_API_KEY is required')
}
```

### 9.2 环境隔离

```typescript
// 生产环境：严格验证
if (isProduction() && !config.wechat.validateSignature) {
  throw new Error('Signature validation must be enabled in production')
}

// 生产环境：禁用调试
if (isProduction()) {
  console.log = () => {}  // 禁用console.log
  console.debug = () => {}
}
```

### 9.3 CORS配置

```typescript
// 开发：宽松
development: {
  corsOrigins: ['http://localhost:3001', 'http://localhost:5173']
}

// 生产：严格
production: {
  corsOrigins: ['https://yourdomain.com']
}
```

---

## 十、迁移计划

### 阶段1：配置文件重构（1-2天）
- [ ] 创建 config/ 目录结构
- [ ] 分离三大环境配置
- [ ] 添加类型定义
- [ ] 更新所有引用

### 阶段2：数据库迁移（2-3天）
- [ ] 准备PostgreSQL环境
- [ ] 测试数据迁移脚本
- [ ] 更新Prisma配置
- [ ] 验证功能兼容性

### 阶段3：部署流程优化（3-5天）
- [ ] 编写Docker配置
- [ ] 配置CI/CD流程
- [ ] 设置监控告警
- [ ] 文档更新

### 阶段4：测试与验证（2-3天）
- [ ] 三大环境功能测试
- [ ] 性能压测
- [ ] 安全审计
- [ ] 灰度发布

---

## 十一、成本估算

| 环境 | 基础设施 | 月成本 |
|------|----------|--------|
| Development | 本地机器 | ¥0 |
| Staging | 小型云服务器 | ¥200-500 |
| Production | 高配云服务器 + CDN + 数据库 | ¥1000-3000 |

**总计**：¥1200-3500/月

---

## 十二、后续优化方向

1. **多云部署**：AWS + 阿里云，容灾备份
2. **边缘计算**：CDN + Edge Functions，降低延迟
3. **自动扩缩容**：K8s HPA，弹性应对流量
4. **A/B测试平台**：数据驱动决策
5. **全链路追踪**：分布式系统可观测性

---

## 附录：快速检查清单

**上线前必查**：
- [ ] 所有敏感信息已从代码中移除
- [ ] .env.production 未提交到git
- [ ] 生产数据库已备份
- [ ] CORS配置正确
- [ ] 日志级别设置为warn/error
- [ ] 错误追踪已启用
- [ ] API限流已启用
- [ ] SSL证书已配置
- [ ] 域名解析正确
- [ ] 回滚方案已准备
