# 飞书模式自动保存

## 📋 问题背景

之前的自动保存策略会产生大量空文档和草稿文档，导致：
- ❌ 文章列表充斥大量无用空文档
- ❌ 用户体验差，难以找到真正的文章
- ❌ 浪费存储空间

## 🎯 解决方案：飞书模式

参考飞书文档的保存策略，实施**延迟创建 + 智能升级**机制。

## 核心设计

### 1️⃣ 三阶段文档状态

```typescript
type DocumentStatus = 
  | 'TEMP'      // 临时状态（仅前端，未持久化）
  | 'DRAFT'     // 草稿（已持久化，可能被清理）
  | 'NORMAL'    // 正式文档（不会被清理）
```

### 2️⃣ 状态转换规则

```
新建文档
  ↓
TEMP（临时状态）
  ↓ 满足以下任一条件：
  - 内容 ≥ 30字 + 标题非空
  - 内容 ≥ 50字（即使标题为空）
  - 编辑时长 > 3分钟 且 内容 > 10字
  ↓
DRAFT（草稿）
  ↓ 满足以下任一条件：
  - 内容 ≥ 30字
  - 标题非空 + 内容 ≥ 10字
  - 编辑时长 > 3分钟
  - 用户手动保存
  ↓
NORMAL（正式文档）
```

### 3️⃣ 差异化保存延迟

| 状态 | 保存延迟 | 说明 |
|------|----------|------|
| **TEMP** | 10秒 | 给用户更多思考时间 |
| **DRAFT** | 5秒 | 适中的保存频率 |
| **NORMAL** | 3秒 | 快速保存，防止丢失 |

## 主要功能

### 1. 延迟创建机制

**核心逻辑（`useAutoSave.ts`）：**

```typescript
function shouldCreateDocument(
  content: string,
  title: string,
  documentStatus: DocumentStatus,
  editStartTime: Date | null
): boolean {
  if (documentStatus !== 'TEMP') return false
  
  const contentLength = content.trim().length
  const hasTitle = title.trim().length > 0

  // 条件1: 内容 ≥ 30字 + 标题非空
  if (contentLength >= 30 && hasTitle) return true

  // 条件2: 内容 ≥ 50字
  if (contentLength >= 50) return true

  // 条件3: 编辑时长 > 3分钟 且 内容 > 10字
  if (editStartTime && contentLength > 10) {
    const editDuration = Date.now() - editStartTime.getTime()
    if (editDuration > 3 * 60 * 1000) return true
  }

  return false
}
```

### 2. 智能状态升级

**从 DRAFT 到 NORMAL：**

```typescript
function shouldUpgradeToNormal(
  content: string,
  title: string,
  documentStatus: DocumentStatus,
  editStartTime: Date | null
): boolean {
  if (documentStatus !== 'DRAFT') return false

  const contentLength = content.trim().length
  const hasTitle = title.trim().length > 0

  // 条件1: 内容 ≥ 30字
  if (contentLength >= 30) return true

  // 条件2: 标题非空 + 内容 ≥ 10字
  if (hasTitle && contentLength >= 10) return true

  // 条件3: 编辑时长 > 3分钟
  if (editStartTime) {
    const editDuration = Date.now() - editStartTime.getTime()
    if (editDuration > 3 * 60 * 1000) return true
  }

  return false
}
```

### 3. 草稿箱管理

**文章列表（`Articles.tsx`）：**

- 📄 **正式文档**：默认视图，只显示 NORMAL 状态的文档
- 📝 **草稿箱**：切换后显示 DRAFT 状态的文档
- 🗑️ **一键清理**：清理 24小时未编辑 且 内容<10字 的草稿

```typescript
// 清理条件
const drafts = documents.filter(doc => {
  const wordCount = countWords(doc.content)
  const hasTitle = doc.title && !doc.title.includes('未命名')
  const isOld = new Date(doc.updatedAt).getTime() < Date.now() - 24 * 60 * 60 * 1000
  
  return isOld && (wordCount < 10 || !hasTitle)
})
```

### 4. 文档状态指示器

**编辑器底部状态栏（`Editor.tsx`）：**

| 状态 | 图标 | 颜色 | 说明 |
|------|------|------|------|
| **TEMP** | ✏️ 编辑中 | 蓝色 | 临时状态，内容达到30字后自动保存 |
| **DRAFT** | 📝 草稿 | 黄色 | 草稿状态，内容达到30字后自动转为正式文档 |
| **NORMAL** | ✓ 已保存 | 绿色 | 正式文档，已自动保存 |

## 技术实现

### 前端状态管理

**`src/types/app.ts`：**

```typescript
export interface EditorState {
  // ... 其他字段
  documentStatus: DocumentStatus  // 当前文档状态
  documentId: string | null        // 当前文档ID
  editStartTime: Date | null       // 开始编辑时间
}
```

**新增 Actions：**

```typescript
| { type: 'SET_DOCUMENT_STATUS'; payload: DocumentStatus }
| { type: 'SET_DOCUMENT_ID'; payload: string | null }
| { type: 'RESET_DOCUMENT'; payload?: { content?: string; title?: string } }
```

### 自动保存钩子

**`src/hooks/useAutoSave.ts`：**

- `performSave()`：执行保存，包含状态检查和升级逻辑
- `shouldCreateDocument()`：判断是否应该创建文档
- `shouldUpgradeToNormal()`：判断是否应该升级状态
- 差异化延迟：根据文档状态设置不同的保存延迟

### 文章列表优化

**`src/pages/Articles.tsx`：**

- 视图切换标签（正式文档 / 草稿箱）
- 草稿过滤逻辑
- 一键清理草稿功能
- 统计和显示优化

## 用户体验

### 新建文档流程

```
1. 用户点击"新建文档"
   → 编辑器打开，状态：✏️ 编辑中

2. 用户开始输入（< 30字）
   → 状态保持：✏️ 编辑中
   → 10秒后若未达到保存条件，不保存

3. 用户输入 ≥ 30字 + 填写标题
   → 触发首次保存
   → 状态变为：📝 草稿
   → 后续5秒延迟保存

4. 用户继续编辑，内容质量提升
   → 自动升级状态：✓ 已保存
   → 后续3秒延迟保存
```

### 草稿管理流程

```
1. 用户进入"文章管理"
   → 默认显示：📄 正式文档

2. 用户切换到：📝 草稿箱
   → 显示所有草稿文档
   → 显示"清理空草稿"按钮

3. 用户点击"清理空草稿"
   → 系统扫描：24小时未编辑 且 内容<10字
   → 显示待清理数量
   → 用户确认后清理
```

## 优势总结

### ✅ 解决的问题

1. **不再产生大量空文档**
   - 延迟创建机制确保只保存有意义的内容
   
2. **用户体验更流畅**
   - 状态指示器提供即时反馈
   - 差异化延迟适应不同编辑阶段
   
3. **文章列表更清晰**
   - 默认隐藏草稿
   - 草稿箱统一管理
   - 一键清理空草稿

### 📈 性能优化

- 减少不必要的数据库写入
- 本地状态管理优先
- 异步保存不阻塞编辑

### 🎯 专业级保存策略

- 参考飞书文档的成熟方案
- 符合用户预期的行为模式
- 清晰的状态管理和反馈

## 文件清单

### 核心文件

```
src/
├── types/
│   └── app.ts                    # 添加 DocumentStatus 类型
├── utils/
│   └── app-context.tsx           # 添加状态管理 actions
├── hooks/
│   └── useAutoSave.ts            # 核心保存逻辑（完全重写）
├── components/
│   └── Editor.tsx                # 添加状态指示器
└── pages/
    └── Articles.tsx              # 添加草稿箱和清理功能

styles/
├── App.css                       # 状态指示器样式
└── articles.css                  # 草稿箱和清理按钮样式
```

## 后续优化

### 可选功能

1. **自动清理定时任务**
   - 后台定时清理旧草稿
   - 可配置清理周期

2. **草稿箱统计**
   - 显示草稿数量
   - 草稿占用空间

3. **状态转换通知**
   - DRAFT → NORMAL 时轻量提示
   - 可配置是否显示

4. **批量操作**
   - 批量升级草稿
   - 批量归档文档

## 总结

通过实施飞书模式的自动保存策略，我们：

✅ **解决了空文档问题**  
✅ **提升了用户体验**  
✅ **优化了存储效率**  
✅ **提供了专业的文档管理**

这是一个从根本上解决自动保存问题的完整方案！
